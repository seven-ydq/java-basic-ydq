

# 文件的上传与下载

## 所用jar包：

**commons-fileupload-1.3.3.jar**

**commons-io-2.6.jar**



## 文件上传

**需要注意的点：**

1、判断是否为multipart请求

2、文件上传的核心组件：

```java
ServletFileUpload upload = new ServletFileUpload(factory);
```

3、设置每一个item的头部字符编码，其可以防止文件名的中文乱码问题

```
upload.setHeaderEncoding("UTF-8");
```

4、单个文件夹最多可以存放65535个文件，所以在实际中可以根据年月日进行目录管理

```java
				   Calendar now = Calendar.getInstance();
                    int year = now.get(Calendar.YEAR);
                    int month = now.get(Calendar.MONTH) + 1;
                    int day = now.get(Calendar.DAY_OF_MONTH);
                    path = path + "/" + year + "/" + month + "/" + day;
                    File dirFile = new File(path);
                    //当前目录不存在时创建目录
                    if (!dirFile.exists()){
                        dirFile.mkdirs();
                    }
                    //创建目标文件，将来用于保存上传文件
                    File descFile = new File(path,fileName);
```

**具体实现代码如下：**

```java
			//判断是否是multipart请求
        	if (!ServletFileUpload.isMultipartContent(req)){
                throw new RuntimeException("当前请求不能上传文件！");
        	}
        	try {
            //创建一个FileItem工厂
            DiskFileItemFactory factory = new DiskFileItemFactory();

            /*//设置使用临时文件的边界值，大于该值，则使用临时文件，否则则直接写入到内存中
            //单位：字节
            factory.setSizeThreshold(1024 * 1024 * 2);

            //设置临时文件
            String tempPath = this.getServletContext().getRealPath("/temp");
            File temp = new File(tempPath);
            factory.setRepository(temp);*/

            //创建文件上传核心组件
            ServletFileUpload upload = new ServletFileUpload(factory);

            //设置每一个item的头部字符编码，其可以防止文件名的中文乱码问题
            upload.setHeaderEncoding("UTF-8");
            //设置单个文件的最大边界值
            upload.setFileSizeMax(1024 * 1024 * 2);

            //设置一次上传的所有文件的最大边界值
            upload.setSizeMax(1024 * 1024 * 5);

            //解析请求，获取到所有的item
            List<FileItem> items = upload.parseRequest(req);
            //遍历items
            for (FileItem item : items) {
                //若item为普通表单项
                if (item.isFormField()){
                    String name = item.getFieldName();//获取表单项名称
                    String value = item.getString("UTF-8");//获取表单项值
                    System.out.println(name + " = " + value);
                } else {//若item为文件表单项
                    String fileName = item.getName();//获取上传文件原始名
                    //为了区分相同的文件名，在文件名前面加上当前时间
                    fileName = System.currentTimeMillis() + fileName;
                    //获取输入流，其中有上传文件的内容
                    InputStream is = item.getInputStream();
                    //获取文件保存在服务器的路径
                    String path = this.getServletContext().getRealPath("/images");

                    /*Date date = new Date();//获取当前系统日期
                    SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");//格式化日期
                    String now = sdf.format(date);*/
                    //根据年月日在images文件夹下创建新的文件夹以便存放更多文件
                    Calendar now = Calendar.getInstance();
                    int year = now.get(Calendar.YEAR);
                    int month = now.get(Calendar.MONTH) + 1;
                    int day = now.get(Calendar.DAY_OF_MONTH);
                    path = path + "/" + year + "/" + month + "/" + day;
                    File dirFile = new File(path);

                    //当前目录不存在时创建目录
                    if (!dirFile.exists()){
                        dirFile.mkdirs();
                    }

                    //创建目标文件，将来用于保存上传文件
                    File descFile = new File(path,fileName);
                    //创建文件输出流
                    OutputStream os = new FileOutputStream(descFile);
                    //将输入流中的数据写入到输出流中
                    int len = -1;
                    byte[] buffer = new byte[1024];
                    while ((len = is.read(buffer)) != -1) {
                        os.write(buffer,0, len);
                    }
                    //关闭流
                    os.close();
                    is.close();
                    //item.delete();
                }
            }
        } catch (FileUploadException e) {
            e.printStackTrace();
        }
```



## 文件下载

**需要注意的点：**

1、修改响应的头部属性content-disposition值为attachment

2、文件名的中文乱码问题

```java
	    String fileName = "文本文档.txt";
        //按照当前字符编码进行打散
        byte[] bytes = fileName.getBytes("UTF-8");
        //按照目标字符编码进行组装
        fileName = new String(bytes,"ISO8859-1");
```

**具体实现代码如下：**

```java
	    String fileName = "文本文档.txt";
        //按照当前字符编码进行打散
        byte[] bytes = fileName.getBytes("UTF-8");
        //按照目标字符编码进行组装
        fileName = new String(bytes,"ISO8859-1");
		//修改响应的头部属性content-disposition值为attachment
        resp.setHeader("content-disposition","attachment;fileName = " + fileName);
        //获取连接服务器资源的输入流
        InputStream is = this.getServletContext().getResourceAsStream("/images/文本文档.txt");
        //获取输出流
        ServletOutputStream os = resp.getOutputStream();
        //将输入流中的数据写入输出流中
        int len = -1;
        byte[] buffer = new byte[1024];
        while ((len = is.read(buffer)) != -1) {
            os.write(buffer,0, len);
        }
        //关闭流
        os.close();
        is.close();
```

